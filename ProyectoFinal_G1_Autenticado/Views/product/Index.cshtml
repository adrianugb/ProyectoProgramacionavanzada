@model IEnumerable<ProyectoFinal_G1_Autenticado.Models.Product>

@{
    ViewBag.Title = "Catálogo de Productos";

    var productosMostrar = User.IsInRole("Administrador")
        ? Model
        : Model.Where(p => p.Status == ProyectoFinal_G1_Autenticado.Models.ProductStatus.Activo);

    var searchName = ViewBag.SearchName as string;
    decimal? minPrice = ViewBag.MinPrice as decimal?;
    decimal? maxPrice = ViewBag.MaxPrice as decimal?;
    bool onlyAvailable = ViewBag.OnlyAvailable != null && (bool)ViewBag.OnlyAvailable;
}

<h2>Catálogo de Productos</h2>

<p>
    @if (User.IsInRole("Administrador"))
    {
        @Html.ActionLink("Crear Producto", "Create", null, new { @class = "btn btn-primary" })
    }
</p>

<!-- Filtros de búsqueda -->
<div class="panel panel-default">
    <div class="panel-heading">
        <strong>Buscar y filtrar productos</strong>
    </div>
    <div class="panel-body">
        @using (Html.BeginForm("Index", "Product", FormMethod.Get))
        {
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        @Html.Label("Nombre")
                        @Html.TextBox("searchName", searchName, new { @class = "form-control", placeholder = "Buscar por nombre..." })
                    </div>
                </div>

                <div class="col-md-2">
                    <div class="form-group">
                        @Html.Label("Precio mínimo")
                        @Html.TextBox("minPrice", minPrice.HasValue ? minPrice.Value.ToString("0.##") : "",
                            new { @class = "form-control", type = "number", step = "0.01", min = "0" })
                    </div>
                </div>

                <div class="col-md-2">
                    <div class="form-group">
                        @Html.Label("Precio máximo")
                        @Html.TextBox("maxPrice", maxPrice.HasValue ? maxPrice.Value.ToString("0.##") : "",
                            new { @class = "form-control", type = "number", step = "0.01", min = "0" })
                    </div>
                </div>

                <div class="col-md-2">
                    <div class="checkbox" style="margin-top:25px;">
                        <label>
                            <input type="checkbox" name="onlyAvailable" value="true" @(onlyAvailable ? "checked=\"checked\"" : "") />
                            Solo disponibles (con stock)
                        </label>
                    </div>
                </div>

                <div class="col-md-2" style="margin-top:25px;">
                    <button type="submit" class="btn btn-primary btn-block">
                        Buscar
                    </button>
                </div>
            </div>
        }
    </div>
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Imagen</th>
            <th>Código</th>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Estado</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in productosMostrar)
        {
            var firstImg = item.Images?.OrderBy(i => i.SortOrder).FirstOrDefault();
            <tr>
                <td style="width:120px;">
                    @if (firstImg != null)
                    {
                        <img src="@Url.Action("GetImage", "Product", new { id = firstImg.Id })"
                             alt="img" class="img-thumbnail" style="max-height:80px;" />
                    }
                </td>
                <td>@item.Code</td>
                <td>@Html.ActionLink(item.Name, "Details", new { id = item.Id })</td>
                <td>@String.Format("{0:C}", item.Price)</td>
                <td>@item.Stock</td>
                <td>@item.Status</td>
                <td>
                    <a class="btn btn-sm btn-info" href="@Url.Action("Details", new { id = item.Id })">Ver</a>

                    @if (User.IsInRole("Administrador"))
                    {
                        <a class="btn btn-sm btn-warning" href="@Url.Action("Edit", new { id = item.Id })">Editar</a>
                        <a class="btn btn-sm btn-danger" href="@Url.Action("Delete", new { id = item.Id })">Eliminar</a>
                        <a class="btn btn-sm btn-secondary" href="@Url.Action("ToggleStatus", new { id = item.Id })">
                            @(item.Status == ProyectoFinal_G1_Autenticado.Models.ProductStatus.Activo ? "Inactivar" : "Activar")
                        </a>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>
