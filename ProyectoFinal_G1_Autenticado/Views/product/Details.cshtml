@model ProyectoFinal_G1_Autenticado.Models.Product
@{
    ViewBag.Title = "Detalle del producto";
}

<h2>@Model.Name</h2>

<div class="row">
    <div class="col-md-6">
        <div class="carousel slide" id="productCarousel" data-bs-ride="carousel">
            <div class="carousel-inner">
                @{
                    var images = Model.Images?.OrderBy(i => i.SortOrder).ToList() ?? new List<ProyectoFinal_G1_Autenticado.Models.ProductImage>();
                    for (int i = 0; i < images.Count; i++)
                    {
                        var img = images[i];
                        <div class="carousel-item @(i == 0 ? "active" : "")">
                            <img class="d-block w-100" src="@Url.Action("GetImage", "Product", new { id = img.Id })" alt="">
                        </div>
                    }
                }
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
        </div>
    </div>

    <div class="col-md-6">
        <h4>Código: @Model.Code</h4>
        <h4>Precio: @String.Format("{0:C}", Model.Price)</h4>
        <h4>Stock: @Model.Stock</h4>
        <h4>Estado: @Model.Status</h4>

        @if (User.IsInRole("Asociado") && Model.Stock > 0 && Model.Status == ProyectoFinal_G1_Autenticado.Models.ProductStatus.Activo)
        {
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <label class="me-2">Cantidad:</label>
                        <input type="number" id="quantity" value="1" min="1" max="@Model.Stock" class="form-control me-2" style="width:80px;" />
                        <button class="btn btn-success" onclick="addToCart(@Model.Id)" id="btnAddCart">
                            <span class="spinner-border spinner-border-sm me-1" id="spinnerAdd" style="display:none;"></span>
                            <span id="btnText">Agregar al Carrito</span>
                        </button>
                    </div>
                    <div id="cartMessage" class="mt-2"></div>
                </div>
            </div>
        }
        else if (!User.Identity.IsAuthenticated)
        {
            <div class="alert alert-info mt-3">
                @Html.ActionLink("Inicia sesión", "Login", "Account") para agregar productos al carrito.
            </div>
        }
    </div>
</div>

<hr />

<h4>Reseñas</h4>
@if (Model.Reviews != null && Model.Reviews.Any())
{
    foreach (var r in Model.Reviews)
    {
        <div class="card mb-2">
            <div class="card-body">
                <strong>Rating: @r.Rating / 5</strong>
                <p>@r.Comment</p>
                <small class="text-muted">@r.CreatedAt.ToString("g")</small>
            </div>
        </div>
    }
}
else
{
    <p>No hay reseñas aprobadas para este producto.</p>
}

@section scripts {
    <script>
        function addToCart(productId) {
            var quantity = parseInt($('#quantity').val()) || 1;
            var btn = $('#btnAddCart');
            var spinner = $('#spinnerAdd');
            var btnText = $('#btnText');
            
            btn.prop('disabled', true);
            spinner.show();
            btnText.text('Agregando...');

            $.ajax({
                url: '/api/cart/add',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ ProductId: productId, Quantity: quantity }),
                success: function (data) {
                    $('#cartMessage').html('<div class="alert alert-success">' + data.message + '</div>');
                    // Actualizar contador del navbar
                    if (typeof updateCartCount === 'function') {
                        updateCartCount();
                    }
                },
                error: function (xhr) {
                    var msg = 'Error al agregar al carrito';
                    if (xhr.status === 401) {
                        msg = 'Debes iniciar sesión';
                    } else if (xhr.responseJSON && xhr.responseJSON.Message) {
                        msg = xhr.responseJSON.Message;
                    }
                    $('#cartMessage').html('<div class="alert alert-danger">' + msg + '</div>');
                },
                complete: function () {
                    btn.prop('disabled', false);
                    spinner.hide();
                    btnText.text('Agregar al Carrito');
                }
            });
        }
    </script>
}
